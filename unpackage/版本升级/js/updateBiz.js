function UpdateBiz(a){this.debug=false;this.callback=a;UpdateBiz.END=0;UpdateBiz.START_LOADING=1;UpdateBiz.LOADING=2;UpdateBiz.SUCCESS=3}UpdateBiz.prototype.start=function(){var a=this;plus.runtime.getProperty(plus.runtime.appid,function(b){localStorage.setItem("version",b.version);if(!a.insallLocVersion()){a.getNewInfo(b.version)}})};UpdateBiz.prototype.insallLocVersion=function(a){var b=localStorage.getItem("LocVersion");this.debug&&console.log("本地安装包=="+b);if(b){localStorage.removeItem("LocVersion");this.install(b);return true}else{return false}};UpdateBiz.prototype.getNewInfo=function(a){var b=this;ajaxData(Host+"api/my/GetNewVersions",function(j){try{var i=j.Data;if(i&&i.VersionsNo){var g=i.Terminal;var h=UserObj.getTestTag();var k=g==3;if(g==0||k||(g==1&&h==1)||(g==2&&h==2)){var d=Number(i.VersionsNo.replace(".",""));var f=Number(a.replace(".",""));if(d>f&&i.PackageUrl){var c=k?UpdateBiz.END:UpdateBiz.START_LOADING;b.callback&&b.callback(c,i.VersionsNo);b.download("http://123.207.55.23:61/pages/DownLoad.ashx?id="+i.VersionsId,g);return}}}}catch(l){}b.callback&&b.callback(UpdateBiz.END)},null,function(){b.callback&&b.callback(UpdateBiz.END)},true)};UpdateBiz.prototype.download=function(d,b){var c=this;c.debug&&console.log("开始下载=="+d);var e=plus.downloader.createDownload(d,{method:"GET",filename:"_doc/update/"},function(g,f){var h=g.filename;if(f==200){c.debug&&console.log("安装包下载成功=="+h);if(b){localStorage.setItem("LocVersion",h)}else{c.install(h)}}else{c.debug&&console.log("安装包下载失败=="+h);if(!b){c.callback&&c.callback(UpdateBiz.END)}}});if(!b){var a=0;e.addEventListener("statechanged",function(g,f){switch(g.state){case 1:c.debug&&console.log("开始下载...");break;case 2:c.debug&&console.log("已连接到服务器");break;case 3:if(g.totalSize>0){var h=g.downloadedSize/g.totalSize*100;h=Math.round(h);if(h-a>2){a=h;c.callback&&c.callback(UpdateBiz.LOADING,"",h);c.debug&&console.log("下载进度=="+h)}}break;case 4:c.debug&&console.log("下载完成100%");break}})}e.start()};UpdateBiz.prototype.install=function(b){var a=this;a.debug&&console.log("开始安装=="+b);plus.runtime.install(b,{force:true},function(c){a.debug&&console.log("安装成功=="+b);a.removeFile(b,function(){a.callback&&a.callback(UpdateBiz.SUCCESS)})},function(c){a.debug&&console.log("安装失败=="+JSON.stringify(c));a.removeFile(b,function(){a.callback&&a.callback(UpdateBiz.END)})})};UpdateBiz.prototype.removeFile=function(b,c){if(b){var a=this;plus.io.resolveLocalFileSystemURL(b,function(d){d.remove(function(e){a.debug&&console.log("文件删除成功=="+b);c&&c()},function(f){a.debug&&console.log("文件删除失败="+b);c&&c()})})}};