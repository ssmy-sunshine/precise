/*
 * mescroll -- 精致的下拉刷新和上拉加载js框架  ( a great JS framework for pull-refresh and pull-up-loading )
 * version 1.1.1
 * 2017-07-15
 * https://github.com/mescroll/mescroll.git
 * http://www.mescroll.com
 * author: wenju < mescroll@qq.com >
 */
function MeScroll(a,b){this.scrollDom=document.getElementById(a);this.options=b||{};this.isDownScrolling=false;this.isUpScrolling=false;this.initDownScroll();this.initUpScroll();var c=this;setTimeout(function(){if(c.optDown.auto){if(c.optDown.autoShowLoading){c.triggerDownScroll()}else{c.optDown.callback&&c.optDown.callback(c)}}c.optUp.auto&&c.triggerUpScroll()},30)}MeScroll.prototype.extendDownScroll=function(b){var a=!!navigator.userAgent.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/);MeScroll.extend(b,{use:true,auto:true,autoShowLoading:false,isLock:false,isBoth:false,offset:80,outOffsetRate:0.2,mustToTop:!a,hardwareClass:"mescroll-hardware",warpClass:"mescroll-downwarp",resetClass:"mescroll-downwarp-reset",htmlContent:'<p class="downwarp-progress"></p><p class="downwarp-tip">下拉刷新 </p>',inited:function(d,c){d.downTipDom=c.getElementsByClassName("downwarp-tip")[0];d.downProgressDom=c.getElementsByClassName("downwarp-progress")[0]},inOffset:function(c){if(c.downTipDom){c.downTipDom.innerHTML="下拉刷新"}if(c.downProgressDom){c.downProgressDom.classList.remove("mescroll-rotate")}},outOffset:function(c){if(c.downTipDom){c.downTipDom.innerHTML="释放更新"}},onMoving:function(d,f,c){if(d.downProgressDom){var e=360*f;d.downProgressDom.style.webkitTransform="rotate("+e+"deg)";d.downProgressDom.style.transform="rotate("+e+"deg)"}},beforeLoading:function(d,c){return false},showLoading:function(c){if(c.downTipDom){c.downTipDom.innerHTML="加载中 ..."}if(c.downProgressDom){c.downProgressDom.classList.add("mescroll-rotate")}},callback:function(c){c.resetUpScroll()}})};MeScroll.prototype.extendUpScroll=function(a){MeScroll.extend(a,{use:true,auto:false,isLock:false,isBoth:false,callback:null,page:{num:0,size:10,time:null},noMoreSize:5,offset:100,resetShowDownScroll:false,toTop:{src:null,offset:1000,warpClass:"mescroll-totop",showClass:"mescroll-fade-in",hideClass:"mescroll-fade-out",duration:300},loadFull:{use:false,delay:500},empty:{warpId:null,icon:null,tip:"暂无相关数据~",btntext:"",btnClick:null},clearId:null,clearEmptyId:null,hardwareClass:"mescroll-hardware",warpClass:"mescroll-upwarp",htmlLoading:'<p class="upwarp-progress mescroll-rotate"></p><p class="upwarp-tip">加载中..</p>',htmlNodata:'<p class="upwarp-nodata">-- END --</p>',inited:function(b,c){},showLoading:function(b,c){c.innerHTML=b.optUp.htmlLoading},showNoMore:function(b,c){c.innerHTML=b.optUp.htmlNodata},onScroll:null})};MeScroll.extend=function(b,a){if(!b){return a}for(key in a){if(b[key]==null){b[key]=a[key]}else{if(typeof b[key]=="object"){MeScroll.extend(b[key],a[key])}}}return b};MeScroll.prototype.initDownScroll=function(){var c=this;c.optDown=c.options.down||{};if(c.optDown.use==false){return}c.extendDownScroll(c.optDown);c.downwarp=document.createElement("div");c.downwarp.className=c.optDown.warpClass;c.downwarp.innerHTML='<div class="downwarp-content">'+c.optDown.htmlContent+"</div>";c.scrollDom.insertBefore(c.downwarp,c.scrollDom.firstChild);c.scrollDom.addEventListener("touchstart",b);c.scrollDom.addEventListener("mousedown",b);function b(f){if(c.isScrollTo){f.preventDefault()}c.startTop=c.scrollDom.scrollTop;if(c.optDown.mustToTop){c.startY=f.touches?f.touches[0].pageY:f.clientY}}c.scrollDom.addEventListener("touchmove",a);c.scrollDom.addEventListener("mousemove",a);function a(j){if(c.startTop!=null&&c.scrollDom.scrollTop<=0&&!c.isDownScrolling&&(!c.isUpScrolling||(c.isUpScrolling&&c.optUp.isBoth))&&!c.optDown.isLock){if(c.optDown.mustToTop&&c.startTop>0){return}var f=j.touches?j.touches[0].pageY:j.clientY;if(!c.preY){c.preY=f}var i=f-c.preY;c.preY=f;if(!c.startY&&!c.optDown.mustToTop){c.startY=f}var h=f-c.startY;if(h>0){j.preventDefault();if(!c.downHight){c.downHight=0}if(c.downHight<c.optDown.offset){if(c.movetype!=1){c.movetype=1;c.optDown.inOffset(c);c.downwarp.classList.remove(c.optDown.resetClass);c.scrollDom.classList.add(c.optDown.hardwareClass);c.scrollDom.style.webkitOverflowScrolling="auto";c.isMoveDown=true}c.downHight+=i}else{if(c.movetype!=2){c.movetype=2;c.optDown.outOffset(c);c.downwarp.classList.remove(c.optDown.resetClass);c.scrollDom.classList.add(c.optDown.hardwareClass);c.scrollDom.style.webkitOverflowScrolling="auto";c.isMoveDown=true}if(i>0){c.downHight+=i*c.optDown.outOffsetRate}else{c.downHight+=i}}c.downwarp.style.height=c.downHight+"px";var g=c.downHight/c.optDown.offset;c.optDown.onMoving(c,g,c.downHight)}}}c.scrollDom.addEventListener("touchend",d);c.scrollDom.addEventListener("mouseup",d);c.scrollDom.addEventListener("mouseleave",d);function d(f){if(c.isMoveDown){c.downwarp.classList.add(c.optDown.resetClass);if(c.downHight>=c.optDown.offset){c.triggerDownScroll()}else{c.downHight=0;c.downwarp.style.height=0}c.scrollDom.style.webkitOverflowScrolling="touch";c.scrollDom.classList.remove(c.optDown.hardwareClass);c.movetype=0;c.isMoveDown=false}c.startY=0;c.preY=0;c.startTop=null}setTimeout(function(){c.optDown.inited(c,c.downwarp)},0)};MeScroll.prototype.triggerDownScroll=function(){if(!this.optDown.beforeLoading(this,this.downwarp)){this.showDownScroll();this.optDown.callback&&this.optDown.callback(this)}};MeScroll.prototype.showDownScroll=function(){this.isDownScrolling=true;this.optDown.showLoading(this);this.downHight=this.optDown.offset;this.downwarp.style.height=this.optDown.offset+"px"};MeScroll.prototype.endDownScroll=function(){this.downHight=0;this.downwarp.style.height=0;this.isDownScrolling=false};MeScroll.prototype.lockDownScroll=function(a){if(a==null){a=true}this.optDown.isLock=a};MeScroll.prototype.initUpScroll=function(){var a=this;a.optUp=a.options.up||{};if(a.optUp.use==false){return}a.extendUpScroll(a.optUp);a.upwarp=document.createElement("div");a.upwarp.className=a.optUp.warpClass;a.scrollDom.appendChild(a.upwarp);a.scrollDom.addEventListener("scroll",function(){var c=a.scrollDom.scrollTop;if(!a.isUpScrolling&&(!a.isDownScrolling||(a.isDownScrolling&&a.optDown.isBoth))){if(!a.optUp.isLock){var b=a.scrollDom.scrollHeight-a.scrollDom.clientHeight-c;if(b<=a.optUp.offset){a.triggerUpScroll()}}if(a.optUp.toTop.src){if(c>=a.optUp.toTop.offset){a.showTopBtn()}else{a.hideTopBtn()}}}a.optDown.onScroll&&a.optDown.onScroll(a,c)});setTimeout(function(){a.optUp.inited(a,a.upwarp)},0)};MeScroll.prototype.triggerUpScroll=function(){this.showUpScroll();this.optUp.page.num++;this.optUp.callback&&this.optUp.callback(this.optUp.page,this)};MeScroll.prototype.showUpScroll=function(){this.isUpScrolling=true;this.upwarp.classList.add(this.optUp.hardwareClass);this.upwarp.style.visibility="visible";this.optUp.showLoading(this,this.upwarp)};MeScroll.prototype.showNoMore=function(){this.upwarp.style.visibility="visible";this.optUp.isLock=true;this.optUp.showNoMore(this,this.upwarp)};MeScroll.prototype.hideUpScroll=function(){this.upwarp.style.visibility="hidden";this.upwarp.classList.remove(this.optUp.hardwareClass)};MeScroll.prototype.endUpScroll=function(a){if(a!=null){if(a){this.showNoMore()}else{this.hideUpScroll()}}this.isUpScrolling=false};MeScroll.prototype.resetUpScroll=function(){if(this.optUp&&this.optUp.use){var a=this.optUp.page;this.prePageNum=a.num;this.prePageTime=a.time;a.num=1;a.time="";if(!this.isDownScrolling){this.clearDataList();if(this.optUp.resetShowDownScroll&&this.optDown.use){this.showDownScroll()}else{this.showUpScroll()}}this.optUp.callback&&this.optUp.callback(a,this)}};MeScroll.prototype.clearDataList=function(){var b=this.optUp.clearId||this.optUp.clearEmptyId;if(b){var a=document.getElementById(b);if(a){a.innerHTML=""}}};MeScroll.prototype.endSuccess=function(b,d){if(this.isDownScrolling){this.endDownScroll()}if(this.optUp.use){var e=this.optUp.page.num;var a=this.optUp.page.size;if(e==1){this.clearDataList()}var c;if(b!=null){if(b<a){this.optUp.isLock=true;if(b==0&&e==1){c=false;this.showEmpty()}else{var f=(e-1)*a+b;if(f<this.optUp.noMoreSize){c=false}else{c=true}this.removeEmpty()}}else{c=false;this.optUp.isLock=false;this.removeEmpty()}}if(e==1&&d){this.optUp.page.time=d}this.endUpScroll(c);this.loadFull()}};MeScroll.prototype.endErr=function(){if(this.isDownScrolling){var a=this.optUp.page;if(a&&this.prePageNum){a.num=this.prePageNum;a.time=this.prePageTime}this.endDownScroll()}if(this.isUpScrolling){this.optUp.page.num--;this.endUpScroll()}};MeScroll.prototype.loadFull=function(){var a=this;if(a.optUp.loadFull.use&&!a.optUp.isLock&&a.scrollDom.scrollHeight<=a.scrollDom.clientHeight){setTimeout(function(){if(a.scrollDom.scrollHeight<=a.scrollDom.clientHeight){a.triggerUpScroll()}},a.optUp.loadFull.delay)}};MeScroll.prototype.lockUpScroll=function(a){if(a==null){a=true}this.optUp.isLock=a};MeScroll.prototype.showEmpty=function(){var b=this;var c=b.optUp.empty;var a=c.warpId||b.optUp.clearEmptyId;if(a==null){return}var f=document.getElementById(a);if(f){b.removeEmpty();var e="";if(c.icon){e+='<img class="empty-icon" src="'+c.icon+'"/>'}if(c.tip){e+='<p class="empty-tip">'+c.tip+"</p>"}if(c.btntext){e+='<p class="empty-btn">'+c.btntext+"</p>"}b.emptyDom=document.createElement("div");b.emptyDom.className="mescroll-empty";b.emptyDom.innerHTML=e;f.appendChild(b.emptyDom);if(c.btnClick){var d=b.emptyDom.getElementsByClassName("empty-btn")[0];d.onclick=function(){c.btnClick()}}}};MeScroll.prototype.removeEmpty=function(){if(this.emptyDom){var a=this.emptyDom.parentNode;if(a){a.removeChild(this.emptyDom)}this.emptyDom=null}};MeScroll.prototype.showTopBtn=function(){if(!this.topBtnShow){this.topBtnShow=true;var a=this;var b=a.optUp.toTop;if(a.toTopBtn==null){a.toTopBtn=document.createElement("img");a.toTopBtn.className=b.warpClass;a.toTopBtn.src=b.src;a.toTopBtn.onclick=function(){a.scrollTo(0,a.optUp.toTop.duration)};document.body.appendChild(a.toTopBtn)}a.toTopBtn.classList.remove(b.hideClass);a.toTopBtn.classList.add(b.showClass)}};MeScroll.prototype.hideTopBtn=function(){if(this.topBtnShow&&this.toTopBtn){this.topBtnShow=false;this.toTopBtn.classList.remove(this.optUp.toTop.showClass);this.toTopBtn.classList.add(this.optUp.toTop.hideClass)}};MeScroll.prototype.scrollTo=function(h,k){k=k||300;var f=20;var e=k/f;var g=this;var a=g.scrollDom.scrollHeight-g.scrollDom.clientHeight;if(h<0){h=0}if(h>a){h=a}var j=g.scrollDom.scrollTop-h;if(j==0){return}var b=j/e;g.isScrollTo=true;var c=0;var d=window.setInterval(function(){if(c<e){if(c==e-1){g.scrollDom.scrollTop=h}else{g.scrollDom.scrollTop-=b}c++}else{g.isScrollTo=false;window.clearInterval(d)}},f)};

/*
 *下拉刷新和上拉加载js
 * 
1.引用mescroll.min.css和mescroll.min.js; 并检查相关图片路径是否引用正确;

2.拷贝以下布局结构
<div id="mescroll" class="mescroll"> // id可修改,但class不能改;另外mescroll的height: 100%,所以父布局要有高度,否则无法触发上拉加载.
	//滑动区域的内容,如:<ul>列表数据</ul> ...
</div>

3.创建MeScroll对象,内部已默认开启下拉刷新
var mescroll = initMeScroll("mescroll", {
//	down:{
//		auto: true, //是否在初始化完毕之后自动执行下拉回调callback; 默认true
//		callback: function() {
//			mescroll.resetUpScroll();//下拉刷新的回调,默认重置上拉加载列表为第一页
//		}
//	},
	up: {
//		auto: false, //是否在初始化时以上拉加载的方式自动加载第一页数据; 默认false
		callback: getListData, //上拉回调,此处可简写; 相当于 callback: function (page) { getListData(page); }
	}
});

function getListData(page){
	$.ajax({
        type: 'GET',
        url: 'xxxxxx?num='+page.num+"&size="+page.size,
        dataType: 'json',
        success: function(data){
        	//联网成功的回调,隐藏下拉刷新和上拉加载的状态;(参数:当前页数据的总数)
			mescroll.endSuccess(data.length);//如果传了参数,mescroll会自动判断列表若无任何数据,则提示空;列表无下一页数据,则提示无更多数据;如果不传参数则仅隐藏加载中的状态
			//设置列表数据
			//setListData(data);
        },
        error: function(data){
        	//联网失败的回调,隐藏下拉刷新和上拉加载的状态;
	        mescroll.endErr();
        }
    });
}

其他常用方法:
1.主动触发下拉刷新 mescroll.triggerDownScroll();
2.主动触发上拉加载 mescroll.triggerUpScroll();
3.重置列表 mescroll.resetUpScroll();
4.滚动列表到指定位置 mescroll.scrollTo(y); (y=0回到列表顶部;如需滚动到列表底部,可设置y很大的值,比如y=99999);
5.获取下拉刷新的配置 mescroll.optDown;
6.获取上拉加载的配置 mescroll.optUp;
7.锁定下拉刷新 mescroll.lockDownScroll(isLock); (isLock=ture,null锁定;isLock=false解锁)
8.锁定上拉加载 mescroll.lockUpScroll(isLock); (isLock=ture,null锁定;isLock=false解锁)
**/
function initMeScroll(mescrollId, options) {
	//自定义的配置 
	var myOption={
		up:{
			toTop: {
				src: "../img/mescroll-totop.png" //回到顶部按钮的图片路径
			},
			empty: {
				//列表第一页无任何数据时,显示的空提示布局; 需配置warpId或clearEmptyId才生效;
				icon: "../img/logo-gray.png", //图标
			}
		}
	}
	//加入自定义的默认配置
	options=MeScroll.extend(options,myOption);
	//创建MeScroll对象
	return new MeScroll(mescrollId,options);
}